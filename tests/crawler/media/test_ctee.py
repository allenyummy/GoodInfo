# encoding=utf-8
# Author: Yu-Lun Chiang
# Description: Test NewsCrawler

import logging
import pytest
from collections import namedtuple
from src.crawler.media import ctee
from src.utils.struct import NewsStruct

logger = logging.getLogger(__name__)


TEST_DATA = namedtuple(
    typename="TEST_DATA",
    field_names=[
        "name",
        "link",
        "expected_output",
    ],
)

TEST_DATA_1 = TEST_DATA(
    name="å·¥å•†æ™‚å ±_1",
    link="https://ctee.com.tw/news/stocks/491412.html",
    expected_output=NewsStruct(
        title="7/21ç›¤å‰æŽƒæã€‹300å„„ä¸Šè†› è¬æµ·å†æ“´èˆ¹éšŠ",
        content="è¬æµ·è¡¨ç¤ºï¼Œå…¨çƒç¼ºèˆ¹ã€ç¼ºæ«ƒæ½®å¸¶å‹•èˆ¹èˆ¶èˆ‡è²¨æ«ƒç§Ÿé‡‘é£†æ¼²ï¼Œå°ç¶“ç‡Ÿæˆæœ¬é€ æˆå£“åŠ›ï¼Œæ“šèª¿æŸ¥èˆ¹èˆ¶ç§Ÿé‡‘è¿‘ä¸€å¹´ä¾†å¤§æ¼²ä¸‰ï½žå››å€ã€‚è¬æµ·å› æ‡‰å…§ç§Ÿèˆ¹ç§Ÿé‡‘æé«˜ã€ç§ŸæœŸè·Ÿè‘—å¢žåŠ ï¼Œèˆ¹èˆ¶èª¿åº¦ä»¥åŠèµ·ã€è§£ç§Ÿéœ€æ±‚å¢žåŠ â€¦é–±è®€å…¨æ–‡\nå—æ¨‚è§€è²¡å ±é¼“èˆžï¼ŒæŠ•è³‡äººå°ç¶“æ¿Ÿå¾©ç”¦çš„çœ‹æ³•æ¢å¾©æ¨‚è§€ï¼ŒæŠ•è³‡äººé€¢ä½Žè²·é€²ï¼Œç¾Žè‚¡å¤§æ´—ä¸‰æº«æš–ï¼Œ19æ—¥ï¼ˆå‘¨ä¸€ï¼‰å¤§æš´è·Œçš„ä¸‰å¤§æŒ‡æ•¸ï¼Œ 20æ—¥ï¼ˆå‘¨äºŒï¼‰å…¨æ•¸å¼·å‹åå½ˆï¼Œ å¹³å‡æ¼²å¹…å‡é€¾1.5%â€¦é–±è®€å…¨æ–‡\nå°ç©é›»è‚¡åƒ¹åœ¨æ³•èªªæœƒå¾Œä¸‹æŒ«ï¼ŒèŠ±æ——ç’°çƒè­‰åˆ¸å°ç£å€ç ”ç©¶éƒ¨ä¸»ç®¡å¾æŒ¯å¿—æŒ‡å‡ºï¼Œç¬¬äºŒå­£è²¡å ±ä¸å¦‚é æœŸã€ç¬¬ä¸‰å­£æ¯›åˆ©çŽ‡å±•æœ›å·®å¼·äººæ„ï¼Œæ˜¯å¼•å‹•æ®ºç›¤ä¸»å› ï¼Œä¸éŽï¼Œå¸‚å ´é–‹å§‹ä¿®æ­£ä¹‹å‰éŽé«˜çš„æœŸæœ›å€¼â€¦é–±è®€å…¨æ–‡\né«˜ç«¯ï¼ˆ6547ï¼‰ç ”ç™¼çš„æ–°å† è‚ºç‚Žåœ‹ç”¢ç–«è‹—ï¼Œé€šéŽå°ç£ç·Šæ€¥ä½¿ç”¨æŽˆæ¬Šï¼ˆEUAï¼‰ï¼Œæœªä¾†ä¸åƒ…æœ‰æ©Ÿæœƒé€²è»åœ‹éš›æ‰“ä¸–ç•Œç›ƒï¼Œä¹Ÿå°‡åœ¨åœ‹å…§å»ºç½®å®Œæ•´ç–«è‹—ç”¢æ¥­ä¾›æ‡‰éˆâ€¦é–±è®€å…¨æ–‡\nå°è‚¡20æ—¥æ”¶ç›¤é‡æŒ«260.51é»žï¼Œæ”¶åœ¨17528.74é»žï¼Œèˆªæµ·çŽ‹ç´›ç´›è½é›£ï¼Œè²¨æ«ƒä¸‰é›„é•·æ¦®ã€é™½æ˜Žã€è¬æµ·è‚¡åƒ¹ä¸€åº¦é€¼è¿‘è·Œåœï¼Œéƒ½èªªæœ¬å‘¨æ˜¯è¶…ç´šèˆªé‹å‘¨ï¼Œèˆªé‹æ™¯æ°£å¥½åˆ°ä¸è¡Œï¼Œè‚¡åƒ¹æ€Žéº¼æœƒé€™éº¼ä¸çµ¦åŠ›ï¼Ÿåˆ†æžå¸«æŒ‡å‡ºï¼Œèˆªé‹è‚¡çš„åŸºæœ¬é¢çš„ç¢ºéžå¸¸å¥½ï¼Œä½†â€¦é–±è®€å…¨æ–‡\nå—ç¾Žè‚¡é‡æŒ«å½±éŸ¿ï¼Œå°è‚¡20æ—¥é–‹ç›¤å³è·Œç ´æœˆç·šï¼Œç›¤ä¸­æ›´ä¸€åº¦é‡æŒ«è¿‘300é»žï¼Œçµ‚å ´ä¸‹è·Œ260é»žï¼Œä¸‰å¤§æ³•äººå…¨æ•¸ç«™è³£æ–¹ï¼Œåˆè¨ˆå¤§è³£357.9å„„å…ƒï¼Œæ‰€å¹¸ç›¤é¢ä»æœ‰åŒ…æ‹¬æ¬£éŠ“ï¼ˆ3264ï¼‰ã€é€šå˜‰ï¼ˆ3588ï¼‰ç­‰14æª”é€†é¢¨è¡¨ç¾ã€åƒ¹é‡ä¿±æš...é–±è®€å…¨æ–‡\nå°è‚¡å‘¨äºŒé‡æŒ«260é»žï¼Œæ”¶åœ¨17,528é»žï¼Œå…¶ä¸­èˆªé‹å†åº¦æ·ªç‚ºç©ºè¥²ç®­é¶ï¼Œè²¨æ«ƒä¸‰é›„è·Œå¹…8ã€9%ä»¥ä¸Šé€¼è¿‘è·Œåœï¼Œä¸å°‘æ‰‹ä¸­æœ‰èˆ¹ç¥¨çš„æ•£æˆ¶ç›¸ç•¶é©šæ…Œï¼Œæ€¥å•èˆªé‹è‚¡æ˜¯ä¸æ˜¯æ²’æ•‘äº†ã€‚æ³•äººæŒ‡å‡ºâ€¦é–±è®€å…¨æ–‡\n\nðŸŽ¯å·¥å•†æ™‚å ±IGæ–°ç™»å ´ï¼æ¶å…ˆ [æ¨‚Â·è®€] https://www.instagram.com/ctee.ig/ðŸŽ¯åŠ å…¥å·¥å•†æ™‚å ±Telegramé »é“  https://t.me/ctee_telegramðŸŽ¯å¾®è‚¡åŠ›é”äºº-å·¥å•†æ™‚å ±åŠ é—œæ³¨ ðŸ“±ç²¾é¸æ–°èžä¸æ¼æŽ¥!  ",
        keywords=["å°è‚¡", "ç›¤å‰æŽƒæ"],
        category=None,
        media="å·¥å•†æ™‚å ±",
        datetime="2021-07-21",
        link="https://ctee.com.tw/news/stocks/491412.html",
    ),
)

TEST_DATA_2 = TEST_DATA(
    name="å·¥å•†æ™‚å ±_2",
    link="https://ctee.com.tw/news/stocks/487126.html",
    expected_output=NewsStruct(
        title="æ©å¾·ç¦è£•å–¬ç¦ è¨‚å–®æ—ºåˆ°Q4",
        content="æ©å¾·ï¼ˆ1528ï¼‰ã€å–¬ç¦ï¼ˆ1540ï¼‰ã€ç¦è£•ï¼ˆ4513ï¼‰ä¸‰å®¶å·¥å…·æ©Ÿå» æŽ¥å–®æŒçºŒå¥½è½‰ï¼Œè¨‚å–®èƒ½è¦‹åº¦è‡³å°‘çœ‹åˆ°ç¬¬å››å­£ï¼Œé¦–å­£å·²å…¨æ•¸è½‰è™§ç‚ºç›ˆï¼Œå…¨å¹´æ‹šç‡Ÿæ”¶æˆé•·ï¼Œç²åˆ©è½‰æ­£ã€‚\næ©å¾·å·¥å…·æ©ŸåŠæœ¨å·¥æ©Ÿå¹´åº•å‰è¨‚å–®æ»¿è¼‰ï¼Œæœ¨å·¥æ©Ÿé–‹å§‹æŽ¥æ˜Žå¹´è¨‚å–®ï¼Œæ©å¾·è‘£äº‹é•·å»–æ–‡å˜‰è¡¨ç¤ºï¼Œæ˜Žå¹´æ–¥è³‡è‡³å°‘5å„„å…ƒï¼Œåœ¨è‹—æ —æŠ•è³‡æ“´å»ºå·¥å…·æ©Ÿå» ã€‚\nå°ç£å·¥å…·æ©Ÿå» åŽ»å¹´åªæœ‰äºžå´´ï¼ˆ1530ï¼‰ã€ç¨‹æ³°ï¼ˆ1583ï¼‰ã€ç€§æ¾¤ç§‘ï¼ˆ6609ï¼‰ç­‰å°‘æ•¸å·¥å…·æ©Ÿå» ç²åˆ©ï¼Œæ©å¾·ã€å–¬ç¦ã€ç¦è£•ç­‰å‡ºç¾è™§æï¼Œä¸‰å®¶å·¥å…·æ©Ÿå» ä»Šå¹´ç¬¬ä¸€å­£é™¸çºŒæŽ¥ç²å¤§é™¸æˆ–æ­æ´²è¨‚å–®ï¼Œä»Šå¹´é¦–å­£å…¨æ•¸è½‰è™§ç‚ºç›ˆï¼Œç›®å‰åœ¨æ‰‹è¨‚å–®è‡³å°‘ä¸‰ï½žå››å€‹æœˆï¼Œéƒ¨åˆ†å¤§åž‹æ©Ÿå°åœ¨æ‰‹è¨‚å–®é•·é”åŠå¹´ä»¥ä¸Šï¼Œè¨‚å–®èƒ½è¦‹åº¦çœ‹åˆ°ç¬¬å››å­£ã€‚\nç¦è£•æŒçºŒæŽ¥ç²å¤§é™¸åŠå°ç£æ±½è»Šç›¸é—œç”¢æ¥­è¨‚å–®ï¼Œç¬¬ä¸€å­£è½‰è™§ç‚ºç›ˆï¼ŒEPSç‚º0.1å…ƒï¼Œç›®å‰åœ¨æ‰‹è¨‚å–®3å„„å¤šå…ƒï¼Œè¨‚å–®èƒ½è¦‹åº¦çœ‹åˆ°ç¬¬å››å­£ï¼Œä»Šå¹´è¨‚å‡ºç‡Ÿæ”¶æˆé•·ï¼Œç²åˆ©è½‰æ­£çš„ç‡Ÿé‹ç›®æ¨™ã€‚\nç¦è£•è‘£äº‹é•·å¼µå¯¶éŠ˜è¡¨ç¤ºï¼Œçœ‹å¥½é›»å‹•è»ŠåŠåŠå°Žé«”ç­‰ç”¢æ¥­æœªä¾†ç™¼å±•å‰æ™¯ï¼Œæ­£ç©æ¥µå¸ƒå±€ã€‚ç¦è£•é‡å°é›»å‹•è»Šç”¢æ¥­ï¼ŒéŽ–å®šé›»å‹•è»Šé‹°é›»æ± é›¶ä»¶åŠé‹°é›»æ± æ‰˜æž¶ç­‰ç›¸é—œå» å•†ï¼›è‡³æ–¼åŠå°Žé«”ç”¢æ¥­ä½¿ç”¨é‹ç¢³æ–°ææ–™å–ä»£é‹ã€éŽ‚ç­‰ææ–™è£½å“ï¼Œé–‹ç™¼æ‡‰ç”¨åœ¨é‹ç¢³æ–°ææ–™é›¶ä»¶åŠ å·¥æ©Ÿå°ï¼Œæ¶æ”»åŠå°Žé«”ç”¢æ¥­è¨‚å–®ã€‚\nå–¬ç¦æŒ‡å‡ºï¼Œæœ€è¿‘æŒçºŒæŽ¥ç²è¨‚å–®ï¼Œå…¶ä¸­ä»£ç†å•†æŽ¥ç²é•·é”18ç±³çš„å¤§åž‹é¾é–€è¨‚å–®ï¼Œé è¨ˆç¬¬å››å­£å‡ºè²¨ï¼Œç›®å‰åœ¨æ‰‹è¨‚å–®2å„„å¤šå…ƒï¼Œè¨‚å–®èƒ½è¦‹åº¦çœ‹åˆ°ç¬¬å››å­£ï¼Œç›®å‰ç”¢èƒ½é‚„å¯ä»¥æŽ¥æ–°è¨‚å–®ã€‚\næ©å¾·ä»Šå¹´ç¬¬ä¸€å­£å› æ–°å°å¹£åŒ¯çŽ‡å‡å€¼ï¼Œèªåˆ—åŒ¯æ0.17å„„å…ƒï¼Œç¬¬äºŒå­£èªåˆ—åŒ¯æå¯æœ›æ”¶æ–‚ã€‚æ©å¾·å¾·åœ‹å» ç”Ÿç”¢çš„å·¥å…·æ©Ÿä¸»è¦ä¾›è²¨çµ¦å¾·åœ‹ç•¶åœ°ã€å¥§åœ°åˆ©åŠç‘žå£«ç­‰åœ‹å®¶ï¼Œç›®å‰å·¥å…·æ©ŸæŽ¥å–®çœ‹åˆ°å¹´åº•ï¼Œç”¢èƒ½æ»¿è¼‰ï¼Œæ©å¾·æœ¨å·¥æ©Ÿå‡ºè²¨è‡³åŒ—ç¾Žç­‰åœ‹å®¶æŽ¡FOBå ±åƒ¹ï¼Œé‹è²»ç”±å®¢æˆ¶è² æ“”ï¼Œè¼ƒä¸å—é‹è²»é£†æ¼²å½±éŸ¿ã€‚\næ©å¾·æœ¨å·¥æ©Ÿå¹´åº•å‰è¨‚å–®å…¨æ»¿è¼‰ï¼Œé–‹å§‹æŽ¥æ˜Žå¹´è¨‚å–®ï¼Œç¾åœ¨æ‰‹è¨‚å–®13å„„å…ƒï¼Œä»Šå¹´ç‡Ÿæ”¶é ä¼°æ¯”åŽ»å¹´å¾®å¹…æˆé•·ï¼Œä»Šå¹´ç‡Ÿé‹è‘—é‡åœ¨ç¨…å¾Œåˆ©æ½¤è½‰æ­£ï¼Œç›®æ¨™æ˜¯ç²åˆ©è¦å¤§å¹…æˆé•·ã€‚\nå»–æ–‡å˜‰æŒ‡å‡ºï¼Œæ©å¾·åŸºæ–¼å·¥å…·æ©Ÿå» ç”¢èƒ½æ»¿è¼‰ï¼Œæ‰“ç®—åœ¨å°ç£æ“´å»ºç¬¬äºŒç”Ÿç”¢åŸºåœ°ï¼Œç›®å‰è¦åŠƒåœ¨è‹—æ —å»ºå» ï¼Œé è¨ˆæ˜Žå¹´åˆå‹•å·¥ï¼Œæ˜Žå¹´åº•å®Œå·¥ï¼Œä¸»è¦ç”Ÿç”¢é«˜éšŽå¤§åž‹äº”è»¸æ©Ÿï¼Œé€£åŒåœŸåœ°ã€åœŸå»ºåŠæ©Ÿå™¨è¨­å‚™ï¼Œè³‡æœ¬æ”¯å‡ºè‡³å°‘5å„„å…ƒã€‚",
        keywords=["è¨‚å–®", "æ©å¾·", "å–¬ç¦", "ç¦è£•"],
        category=None,
        media="å·¥å•†æ™‚å ±",
        datetime="2021-07-12",
        link="https://ctee.com.tw/news/stocks/487126.html",
    ),
)

TEST_DATA_LIST = [TEST_DATA_1, TEST_DATA_2]


@pytest.fixture(scope="module")
def newsCrawler():
    logger.warning("Init News Crawler ...")
    return ctee.CTEENewsCrawler()


@pytest.mark.parametrize(
    argnames="name, link, expected_output",
    argvalues=[tuple(t) for t in TEST_DATA_LIST],
    ids=[
        f"{t.name}, {t.link[:50]+'...' if len(t.link) > 50 else t.link}"
        for t in TEST_DATA_LIST
    ],
)
def test_get_info(
    newsCrawler,
    name,
    link,
    expected_output,
):
    output = newsCrawler.getInfo(link=link)
    assert NewsStruct.__2dict__(output) == NewsStruct.__2dict__(expected_output)
